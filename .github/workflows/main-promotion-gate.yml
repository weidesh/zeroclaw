name: Main Promotion Gate

on:
    pull_request:
        branches: [main]

concurrency:
    group: main-promotion-${{ github.event.pull_request.number || github.sha }}
    cancel-in-progress: true

permissions:
    contents: read

env:
    GIT_CONFIG_COUNT: "1"
    GIT_CONFIG_KEY_0: core.hooksPath
    GIT_CONFIG_VALUE_0: /dev/null


jobs:
    enforce-dev-promotion:
        name: Enforce Dev -> Main Promotion
        runs-on: [self-hosted, aws-india]
        steps:
            - name: Validate main PR metadata
              shell: bash
              env:
                  HEAD_REF: ${{ github.head_ref }}
                  HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
                  BASE_REPO: ${{ github.repository }}
                  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
              run: |
                  set -euo pipefail

                  if [[ -z "${PR_AUTHOR}" || -z "${HEAD_REF}" ]]; then
                    echo "::error::Missing PR metadata (author/head_ref)."
                    exit 1
                  fi

                  echo "Main PR policy satisfied: author=${PR_AUTHOR}, source=${HEAD_REPO}:${HEAD_REF} -> main"
